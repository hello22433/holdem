<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Holdem Real-time (Binary Optimized)</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        .box { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: 1px solid #999; }
        input, select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        h2 { color: #333; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
    </style>
</head>
<body>
<h2>â™ ï¸ í…ì‚¬ìŠ¤ í™€ë¤ ì‹¤ì‹œê°„ í…Œì´ë¸” (Room 1)</h2>

<div class="box">
    <h3>1. ì„œë²„ ì—°ê²°</h3>
    <button onclick="connect()">ğŸ”Œ ì„œë²„ ì—°ê²° (Connect)</button>
    <span id="status" style="margin-left: 10px; color: gray; font-weight: bold;">ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
</div>

<div class="box">
    <h3>2. í”Œë ˆì´ì–´ ì•¡ì…˜</h3>
    <div>
        <label>ID:</label> <input type="text" id="playerId" value="User_Genius">
        <label>Amount:</label> <input type="number" id="amount" value="1000">
    </div>
    <br>

    <label>Action:</label>
    <select id="actionSelect">
        <option value="0">CHECK (0)</option>
        <option value="1">CALL (1)</option>
        <option value="2" selected>BET (2)</option>
        <option value="3">RAISE (3)</option>
        <option value="4">FOLD (4)</option>
        <option value="5">ALL_IN (5)</option>
    </select>

    <hr/>

    <button onclick="sendJsonBet()">ì¼ë°˜ ë² íŒ… (JSON)</button>

    <button onclick="sendRealBinaryBet()" style="background-color: #d4edda; border: 1px solid #28a745; font-weight: bold;">
        ğŸš€ ìµœì í™” ë² íŒ… (Real Binary)
    </button>
</div>

<h3>ğŸ“º ì‹¤ì‹œê°„ ê²Œì„ ìƒíƒœ (Live)</h3>
<pre id="gameState" style="background:#f0f0f0; padding:15px; border-radius:5px; font-size: 14px;">ì„œë²„ ì—°ê²° í›„ ì•¡ì…˜ì„ ë³´ë‚´ë³´ì„¸ìš”.</pre>

<h3>ğŸ“ ì „ì†¡ ë¡œê·¸ (Log)</h3>
<div id="logs" style="background:#222; color:#0f0; padding:10px; height: 200px; overflow-y: scroll; font-family: monospace; border-radius:5px;"></div>

<script>
    var stompClient = null;
    var tableId = "room1";

    function log(msg) {
        var logs = document.getElementById('logs');
        var div = document.createElement('div');
        div.className = "log-entry";
        div.innerHTML = "> " + msg;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    function connect() {
        var socket = new SockJS('http://localhost:8080/ws-holdem');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            document.getElementById('status').innerText = "âœ… ì—°ê²°ë¨";
            document.getElementById('status').style.color = "green";
            log("ì„œë²„ ì—°ê²° ì„±ê³µ!");

            // [êµ¬ë…] ì„œë²„ê°€ ë³´ë‚´ëŠ” í…Œì´ë¸” ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ìŒ (JSON)
            stompClient.subscribe('/topic/table/' + tableId, function (response) {
                var tableData = JSON.parse(response.body);
                // í™”ë©´ ê°±ì‹ 
                document.getElementById('gameState').innerText =
                    "í˜„ì¬ Pot: " + tableData.pot.totalAmount + "\n" +
                    "ì°¸ê°€ì ìˆ˜: " + tableData.players.length + "\n" +
                    "í˜„ì¬ ë¼ìš´ë“œ: " + tableData.currentRound;

                log("ğŸ“¥ [ìƒíƒœ ê°±ì‹ ] Potì´ " + tableData.pot.totalAmount + "ë¡œ ë³€ê²½ë¨");
            });

            alert("ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! Swaggerë¡œ ë°©(room1)ì„ ë§Œë“¤ê³ , í”Œë ˆì´ì–´(User_Genius)ë¥¼ ì…ì¥ì‹œí‚¨ í›„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.");
        });
    }

    // 1. JSON ì „ì†¡ (ê¸°ì¡´ ë°©ì‹)
    function sendJsonBet() {
        var pid = document.getElementById('playerId').value;
        var amt = document.getElementById('amount').value;
        var select = document.getElementById("actionSelect");
        var actionText = select.options[select.selectedIndex].text.split(" ")[0];

        var jsonPayload = JSON.stringify({
            'playerId': pid,
            'action': actionText,
            'amount': amt
        });

        stompClient.send("/app/table/" + tableId + "/action", {}, jsonPayload);

        var size = new Blob([jsonPayload]).size;
        log("ğŸ“¤ [JSON ì „ì†¡] í¬ê¸°: " + size + " bytes");
    }

    // 2. ë°”ì´ë„ˆë¦¬ ì „ì†¡ (ìµœì í™” ë°©ì‹)
    function sendRealBinaryBet() {
        var pid = document.getElementById('playerId').value;
        var actionVal = parseInt(document.getElementById('actionSelect').value);
        var amt = BigInt(document.getElementById('amount').value);

        // [ì§ë ¬í™”]
        var encoder = new TextEncoder();
        var idBytes = encoder.encode(pid);
        var idLength = idBytes.length;

        // êµ¬ì¡°: [Action(1)] + [Amount(8)] + [ID_Len(4)] + [ID_Body(N)]
        var totalSize = 1 + 8 + 4 + idLength;
        var buffer = new ArrayBuffer(totalSize);
        var view = new DataView(buffer);

        var offset = 0;
        view.setInt8(offset, actionVal); offset += 1;          // Action
        view.setBigInt64(offset, amt); offset += 8;            // Amount
        view.setInt32(offset, idLength); offset += 4;          // ID Length
        new Uint8Array(buffer).set(idBytes, offset);           // ID Bytes

        // [ì „ì†¡] í—¤ë”ì— ë°”ì´ë„ˆë¦¬ íƒ€ì… ëª…ì‹œ
        var headers = {'content-type': 'application/json'};
        var base64Str = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        // stompClient.send("/app/table/" + tableId + "/action/binary", headers, new Uint8Array(buffer));
        stompClient.send("/app/table/" + tableId + "/action/binary", headers, JSON.stringify({data: base64Str}));

        log("ğŸš€ <b>[Binary ì „ì†¡]</b> í¬ê¸°: <span style='color:yellow'>" + totalSize + " bytes</span> (ì••ì¶•ë¨!)");
    }
</script>
</body>
</html>